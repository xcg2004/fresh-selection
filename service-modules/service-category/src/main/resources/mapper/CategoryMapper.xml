<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xcg.servicecategory.mapper.CategoryMapper">

    <insert id="save" parameterType="com.xcg.servicecategory.domain.entity.Category" useGeneratedKeys="true" keyProperty="id">
        insert into category(name,parent_id,level,icon,sort)
        values(#{name},#{parentId},#{level},#{icon},#{sort})
    </insert>
    <!-- 更新排序 -->
    <update id="updateSort">
        UPDATE category
        SET sort = #{sort}, update_time = NOW()
        WHERE id = #{categoryId} AND status = 1
    </update>

    <!-- 锁定父级所有分类 -->
    <select id="lockByParentId" resultType="java.lang.Long">
        SELECT id FROM category
        WHERE parent_id = #{parentId}
            FOR UPDATE
    </select>

    <!-- 范围更新排序值 -->
    <update id="incrementRange">
        UPDATE category
        SET sort = sort + #{increment}
        WHERE parent_id = #{parentId}
        AND sort BETWEEN #{start} AND #{end}
        AND status = 1
        ORDER BY sort
        <choose>
            <when test="increment > 0">DESC</when> <!-- 后移时从大到小 -->
            <otherwise>ASC</otherwise>             <!-- 前移时从小到大 -->
        </choose>
    </update>

    <!-- 查询父级下最大排序值 -->
    <select id="selectMaxSortByParentId" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(sort), 0) FROM category
        WHERE parent_id = #{parentId} AND status = 1
    </select>

    <!-- 悲观锁查询 -->
    <select id="selectByIdForUpdate" resultType="com.xcg.servicecategory.domain.entity.Category">
        SELECT * FROM category
        WHERE id = #{id} AND status = 1
            FOR UPDATE
    </select>

</mapper>
